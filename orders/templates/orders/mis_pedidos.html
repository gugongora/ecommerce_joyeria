{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load custom_filters %} {# si tienes clp_format #}

{% block title %}Mis Pedidos{% endblock %}

{% block main_classes %}pt-[128px] flex-grow max-w-7xl mx-auto px-4 md:px-6 lg:px-8 py-8{% endblock %}

{% block content %}

<div class="space-y-6">

  <!-- Header -->
  <div class="flex items-center justify-between gap-4">
    <div>
      <h1 class="text-2xl md:text-3xl font-semibold text-gray-900">Mis pedidos</h1>
      <p class="text-sm text-gray-600 mt-1">Consulta el historial, estados y comprobantes de tus compras.</p>
    </div>
    <a href="{% url 'store:product_list' %}" class="inline-flex items-center gap-2 rounded-lg bg-[#5e0013] px-4 py-2 text-white hover:bg-[#7a0011] transition shadow-sm">
      Seguir comprando
    </a>
  </div>

  <!-- KPI mini cards -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
    <div class="rounded-xl border border-gray-200 bg-white p-4">
      <p class="text-xs uppercase tracking-wide text-gray-500">Pedidos</p>
      <p class="mt-1 text-2xl font-semibold text-gray-900">{{ page_obj.paginator.count|default:0 }}</p>
    </div>
    <div class="rounded-xl border border-gray-200 bg-white p-4">
      <p class="text-xs uppercase tracking-wide text-gray-500">Gastado total</p>
      <p class="mt-1 text-2xl font-semibold text-gray-900">
        {% with total_spent=total_spent %}
          {{ total_spent|default:0|intcomma }}
        {% endwith %}
      </p>
    </div>
    <div class="rounded-xl border border-gray-200 bg-white p-4">
      <p class="text-xs uppercase tracking-wide text-gray-500">Último pedido</p>
      <p class="mt-1 text-2xl font-semibold text-gray-900">
        {% if last_order %}{{ last_order.created_at|date:"d/m/Y" }}{% else %}-{% endif %}
      </p>
    </div>
  </div>

  <!-- Filtros -->
  <form method="get" class="rounded-xl border border-gray-200 bg-white p-4 flex flex-col md:flex-row md:items-end gap-3">
    <div class="flex-1">
      <label class="block text-xs font-medium text-gray-600 mb-1">Buscar</label>
      <input type="text" name="q" value="{{ request.GET.q }}" placeholder="N° de pedido o texto…"
             class="w-full rounded-lg border-gray-300 focus:ring-[#5e0013] focus:border-[#5e0013]">
    </div>
    <div>
      <label class="block text-xs font-medium text-gray-600 mb-1">Estado</label>
      <select name="status" class="rounded-lg border-gray-300 focus:ring-[#5e0013] focus:border-[#5e0013]">
        <option value="">Todos</option>
        {% for k, v in status_choices.items %}
          <option value="{{ k }}" {% if request.GET.status == k %}selected{% endif %}>{{ v }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="block text-xs font-medium text-gray-600 mb-1">Desde</label>
      <input type="date" name="from" value="{{ request.GET.from }}" class="rounded-lg border-gray-300 focus:ring-[#5e0013] focus:border-[#5e0013]">
    </div>
    <div>
      <label class="block text-xs font-medium text-gray-600 mb-1">Hasta</label>
      <input type="date" name="to" value="{{ request.GET.to }}" class="rounded-lg border-gray-300 focus:ring-[#5e0013] focus:border-[#5e0013]">
    </div>
    <div>
      <button type="submit" class="inline-flex items-center rounded-lg bg-gray-900 text-white px-4 py-2 hover:bg-black transition">Filtrar</button>
    </div>
  </form>

  {% if page_obj.object_list %}
    <!-- Versión móvil: cards -->
    <div class="md:hidden space-y-4">
      {% for pedido in page_obj.object_list %}
      <div class="rounded-xl border border-gray-200 bg-white p-4 shadow-sm">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-xs text-gray-500">Orden</p>
            <p class="font-semibold text-gray-900">{{ pedido.buy_order }}</p>
          </div>
          <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium
            {% if pedido.status == 'paid' or pedido.status == 'completado' %}bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200
            {% elif pedido.status == 'pending' or pedido.status == 'pendiente' %}bg-amber-50 text-amber-700 ring-1 ring-amber-200
            {% elif pedido.status == 'canceled' or pedido.status == 'cancelado' %}bg-rose-50 text-rose-700 ring-1 ring-rose-200
            {% elif pedido.status == 'shipped' or pedido.status == 'enviado' %}bg-blue-50 text-blue-700 ring-1 ring-blue-200
            {% else %}bg-gray-100 text-gray-700 ring-1 ring-gray-200{% endif %}">
            {{ pedido.status|title }}
          </span>
        </div>

        <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
          <div>
            <p class="text-xs text-gray-500">Fecha</p>
            <p class="text-gray-800">{{ pedido.created_at|date:"d/m/Y H:i" }}</p>
          </div>
          <div class="text-right">
            <p class="text-xs text-gray-500">Total</p>
            <p class="font-semibold text-gray-900">
              {% if pedido.total %}{{ pedido.total|clp_format|default:pedido.total|intcomma }}{% else %}-{% endif %}
            </p>
          </div>
        </div>

        {% if pedido.items_count %}
        <p class="mt-2 text-xs text-gray-500">{{ pedido.items_count }} artículo{{ pedido.items_count|pluralize }}</p>
        {% endif %}

        <div class="mt-4 flex flex-wrap gap-2">
          <a href="{% url 'orders:order_confirmation' pedido.id %}" class="inline-flex items-center rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-800 hover:bg-gray-50">Ver detalles</a>
          {% if pedido.invoice_url %}
            <a href="{{ pedido.invoice_url }}" class="inline-flex items-center rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-800 hover:bg-gray-50" target="_blank">Comprobante</a>
          {% endif %}
          <button type="button" data-copy="{{ pedido.buy_order }}" class="copy-order inline-flex items-center rounded-lg bg-[#5e0013] text-white px-3 py-1.5 text-sm hover:bg-[#7a0011]">Copiar código</button>
          {% if pedido.reorder_url %}
            <a href="{{ pedido.reorder_url }}" class="inline-flex items-center rounded-lg bg-gray-900 text-white px-3 py-1.5 text-sm hover:bg-black">Repetir compra</a>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Desktop: tabla -->
    <div class="hidden md:block rounded-xl border border-gray-200 bg-white overflow-hidden">
      <table class="min-w-full divide-y divide-gray-200 text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left font-semibold text-gray-700">Orden</th>
            <th class="px-4 py-3 text-left font-semibold text-gray-700">Fecha</th>
            <th class="px-4 py-3 text-left font-semibold text-gray-700">Estado</th>
            <th class="px-4 py-3 text-right font-semibold text-gray-700">Total</th>
            <th class="px-4 py-3 text-right font-semibold text-gray-700">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% for pedido in page_obj.object_list %}
          <tr class="hover:bg-gray-50">
            <td class="px-4 py-3">
              <div class="flex items-center gap-2">
                <span class="font-medium text-gray-900">{{ pedido.buy_order }}</span>
                {% if pedido.items_count %}
                  <span class="text-xs text-gray-500">· {{ pedido.items_count }} ítem{{ pedido.items_count|pluralize }}</span>
                {% endif %}
              </div>
            </td>
            <td class="px-4 py-3 text-gray-800">{{ pedido.created_at|date:"d/m/Y H:i" }}</td>
            <td class="px-4 py-3">
              <span class="inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium
              {% if pedido.status == 'paid' or pedido.status == 'completado' %}bg-emerald-50 text-emerald-700 ring-1 ring-emerald-200
              {% elif pedido.status == 'pending' or pedido.status == 'pendiente' %}bg-amber-50 text-amber-700 ring-1 ring-amber-200
              {% elif pedido.status == 'canceled' or pedido.status == 'cancelado' %}bg-rose-50 text-rose-700 ring-1 ring-rose-200
              {% elif pedido.status == 'shipped' or pedido.status == 'enviado' %}bg-blue-50 text-blue-700 ring-1 ring-blue-200
              {% else %}bg-gray-100 text-gray-700 ring-1 ring-gray-200{% endif %}">
                {{ pedido.status|title }}
              </span>
            </td>
            <td class="px-4 py-3 text-right font-semibold text-gray-900">
              {% if pedido.total %}{{ pedido.total|clp_format|default:pedido.total|intcomma }}{% else %}-{% endif %}
            </td>
            <td class="px-4 py-3">
              <div class="flex items-center justify-end gap-2">
                <a href="{% url 'orders:order_confirmation' pedido.id %}" class="inline-flex items-center rounded-lg border border-gray-300 px-3 py-1.5 hover:bg-gray-50">Detalles</a>
                {% if pedido.invoice_url %}
                  <a href="{{ pedido.invoice_url }}" target="_blank" class="inline-flex items-center rounded-lg border border-gray-300 px-3 py-1.5 hover:bg-gray-50">Comprobante</a>
                {% endif %}
                <button type="button" data-copy="{{ pedido.buy_order }}" class="copy-order inline-flex items-center rounded-lg bg-[#5e0013] text-white px-3 py-1.5 hover:bg-[#7a0011]">Copiar</button>
                {% if pedido.reorder_url %}
                  <a href="{{ pedido.reorder_url }}" class="inline-flex items-center rounded-lg bg-gray-900 text-white px-3 py-1.5 hover:bg-black">Repetir</a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="flex items-center justify-between pt-4">
      <div class="text-sm text-gray-600">
        Página <span class="font-medium">{{ page_obj.number }}</span> de <span class="font-medium">{{ page_obj.paginator.num_pages }}</span>
      </div>
      <div class="flex items-center gap-2">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}&q={{ request.GET.q }}&status={{ request.GET.status }}&from={{ request.GET.from }}&to={{ request.GET.to }}"
             class="inline-flex items-center rounded-lg border border-gray-300 px-3 py-1.5 hover:bg-gray-50">Anterior</a>
        {% endif %}
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}&q={{ request.GET.q }}&status={{ request.GET.status }}&from={{ request.GET.from }}&to={{ request.GET.to }}"
             class="inline-flex items-center rounded-lg border border-gray-300 px-3 py-1.5 hover:bg-gray-50">Siguiente</a>
        {% endif %}
      </div>
    </div>

  {% else %}
    <!-- Empty state -->
    <div class="rounded-2xl border border-dashed border-gray-300 bg-white p-10 text-center">
      <div class="mx-auto h-12 w-12 rounded-full bg-gray-100 flex items-center justify-center mb-3">👜</div>
      <h3 class="text-lg font-semibold text-gray-900">Aún no tienes pedidos</h3>
      <p class="text-sm text-gray-600 mt-1">Cuando compres, verás aquí el estado y los comprobantes.</p>
      <a href="{% url 'store:product_list' %}" class="mt-5 inline-flex items-center rounded-lg bg-[#5e0013] text-white px-4 py-2 hover:bg-[#7a0011]">Explorar productos</a>
    </div>
  {% endif %}

</div>

<!-- JS: copiar código de pedido -->
<script>
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.copy-order');
    if(!btn) return;
    const code = btn.getAttribute('data-copy');
    try {
      await navigator.clipboard.writeText(code);
      btn.textContent = 'Copiado ✓';
      setTimeout(() => btn.textContent = btn.textContent.includes('Repetir') ? 'Repetir' : 'Copiar', 1500);
    } catch {
      alert('No se pudo copiar');
    }
  });
</script>

{% endblock %}
